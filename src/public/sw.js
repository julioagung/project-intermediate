import { precacheAndRoute } from 'workbox-precaching';
import { registerRoute } from 'workbox-routing';
import { StaleWhileRevalidate, CacheFirst, NetworkFirst } from 'workbox-strategies';
import { ExpirationPlugin } from 'workbox-expiration';

// Precache all assets generated by Vite
precacheAndRoute(self.__WB_MANIFEST);

// Cache static assets with Cache First strategy
registerRoute(
  ({ request }) => request.destination === 'style' ||
                   request.destination === 'script' ||
                   request.destination === 'image',
  new CacheFirst({
    cacheName: 'static-assets',
    plugins: [
      new ExpirationPlugin({
        maxEntries: 60,
        maxAgeSeconds: 30 * 24 * 60 * 60, // 30 days
      }),
    ],
  })
);

// Cache API responses with Network First strategy
registerRoute(
  ({ url }) => url.origin === 'https://story-api.dicoding.dev',
  new NetworkFirst({
    cacheName: 'api-cache',
    plugins: [
      new ExpirationPlugin({
        maxEntries: 100,
        maxAgeSeconds: 5 * 60, // 5 minutes
      }),
    ],
  })
);

// Cache dynamic story data for offline viewing
registerRoute(
  ({ url }) => url.pathname.includes('/stories'),
  new NetworkFirst({
    cacheName: 'stories-cache',
    plugins: [
      new ExpirationPlugin({
        maxEntries: 50,
        maxAgeSeconds: 10 * 60, // 10 minutes for story data
      }),
    ],
  })
);

// Cache user favorites for offline access
registerRoute(
  ({ url }) => url.pathname.includes('/favorites') || url.pathname.includes('/stories/'),
  new NetworkFirst({
    cacheName: 'user-data-cache',
    plugins: [
      new ExpirationPlugin({
        maxEntries: 20,
        maxAgeSeconds: 30 * 60, // 30 minutes for user data
      }),
    ],
  })
);

// Cache Leaflet tiles with Cache First strategy
registerRoute(
  ({ url }) => url.origin === 'https://tile.openstreetmap.org' ||
               url.origin === 'https://server.arcgisonline.com',
  new CacheFirst({
    cacheName: 'map-tiles',
    plugins: [
      new ExpirationPlugin({
        maxEntries: 200,
        maxAgeSeconds: 7 * 24 * 60 * 60, // 7 days
      }),
    ],
  })
);

// Handle push notifications
self.addEventListener('push', (event) => {
  if (!event.data) return;

  const data = event.data.json();
  const options = {
    body: data.body || 'New story available!',
    icon: data.icon || '/favicon.png',
    badge: '/favicon.png',
    image: data.image || null, // Add support for story images
    vibrate: [200, 100, 200, 100, 200], // Enhanced vibration pattern
    requireInteraction: true, // Keep notification visible until user interacts
    silent: false,
    tag: `story-${data.storyId || 'general'}`, // Group similar notifications
    renotify: true,
    data: {
      dateOfArrival: Date.now(),
      primaryKey: data.primaryKey || 1,
      storyId: data.storyId,
      action: data.action || 'view',
      author: data.author || 'Anonymous',
      location: data.location || null,
    },
    actions: [
      {
        action: 'view',
        title: 'ðŸ“– View Story',
        icon: '/favicon.png'
      },
      {
        action: 'share',
        title: 'ðŸ”— Share',
        icon: '/favicon.png'
      },
      {
        action: 'dismiss',
        title: 'âŒ Dismiss'
      }
    ],
    // Enhanced styling for better visual appeal
    icon: data.icon || '/favicon.png',
    badge: '/favicon.png',
  };

  // Create enhanced notification title with emoji
  const title = data.title ? `ðŸ“¸ ${data.title}` : 'ðŸ“± Dicoding Stories';

  event.waitUntil(
    self.registration.showNotification(title, options)
  );
});

// Handle notification click
self.addEventListener('notificationclick', (event) => {
  event.notification.close();

  const storyId = event.notification.data?.storyId;
  const action = event.action || 'view';

  let url = '/dicoding-stories/';

  if (action === 'view' && storyId) {
    url += `#/story/${storyId}`;
  } else if (action === 'share' && storyId) {
    // Handle share action - could open share dialog or copy link
    url += `#/story/${storyId}`;
    // For now, just navigate to the story
  }

  event.waitUntil(
    clients.matchAll({ type: 'window', includeUncontrolled: true }).then((windowClients) => {
      // Check if there is already a window/tab open with the target URL
      for (let client of windowClients) {
        if (client.url.includes('/dicoding-stories/') && 'focus' in client) {
          return client.focus();
        }
      }
      // If not, open a new window/tab with the target URL
      if (clients.openWindow) {
        return clients.openWindow(url);
      }
    })
  );
});

// Handle install event
self.addEventListener('install', (event) => {
  self.skipWaiting();
});

// Handle activate event
self.addEventListener('activate', (event) => {
  event.waitUntil(
    clients.claim()
  );
});
